<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>APUPU</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
        <!-- Custom Google font-->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@100;200;300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="/css/styles.css" rel="stylesheet" />

        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet" />

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
</head>

    <style>
     
      body{margin-top:20px;}

.chat-online {
    color: #34ce57
}

.chat-offline {
    color: #e4606d
}

.chat-messages {
    display: flex;
    flex-direction: column;
    max-height: 800px;
    overflow-y: scroll
}

.chat-message-left,
.chat-message-right {
    display: flex;
    flex-shrink: 0
}

.chat-message-left {
    margin-right: auto
}

.chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto
}
.py-3 {
    padding-top: 1rem!important;
    padding-bottom: 1rem!important;
}
.px-4 {
    padding-right: 1.5rem!important;
    padding-left: 1.5rem!important;
}
.flex-grow-0 {
    flex-grow: 0!important;
}
.border-top {
    border-top: 1px solid #dee2e6!important;
}
.music{

    margin-bottom: 10px;
}

.music:hover{

    background-color: #f7f7f7;
    border-radius: 3px;
    cursor: pointer;
}
.color{

    color: #ff7e3d;
}



.btn-danger {
    color: #fff;
    background-color: #ff7e3d;
    border-color: #ff7e3d;
}


.btn-danger:hover , 
.btn-danger:active  {
    color: #fff;
    background-color: #ff7e3d;
    border-color: #ff7e3d;
}



.btn-danger:focus{
    box-shadow: none;
}
    </style>
    <body class="d-flex flex-column h-100">
        <main class="flex-shrink-0">
            <!-- Navigation-->
            <nav class="navbar navbar-expand-lg navbar-light bg-white py-3">
                <div class="container px-5">
                    <a class="navbar-brand" href="/"><span class="fw-bolder text-primary">APUPU</span></a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 small fw-bolder">
                            <% if(username){ %>
                                <%- username %> <li class="nav-item"><a class="nav-link" href="sair">(Sair)</a></li>
                              <% } else{ %>  
                                <li class="nav-item"><a class="nav-link" href="login">Entrar</a></li>
                             <% } %>
                        </ul>
                    </div>
                </div>
            </nav>
            
            <div class="container p-0">
              <div class="card">
                <div class="row g-0">
                  <div class="col-12 col-lg-5 col-xl-3 border-right">
                    <div  id="sucesssaveuser" class="alert alert-success" role="alert" style="display: none;">
                      Musica adicionada na playlist
                    </div>
                    <div class="px-4 d-none d-md-block">
                      <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                          <iframe id="currentmusic" width="100%" height="100%" src="" frameborder="0" allow="autoplay" webkitallowfullscreen mozallowfullscreen ></iframe>
                        </div>
                      </div>
                    </div>
                    
                             <div class="p-3 card">
                              <%  for (let music of chatinfo.playlist){ %>
                              <div class="d-flex justify-content-between align-items-center p-3 music" onclick="changeMusic('<%= music.youtubelink %>')">
      
                                  <div class="d-flex flex-row align-items-center">
      
                                      <i class="fa fa-music color"></i>
                                      <small class="ml-2"><%= music.titulo %> - <%= music.artistas %></small>
                                      
                                  </div>
                                  <i class="fa fa-check color"></i>
                              </div>

                              <% } %>
                              <script>
                                function changeMusic(link){
                                  var new_src = "https://www.youtube.com/embed/"+link.split("=")[1]
                                  var socket2 = io();

                                  socket2.emit('mudar musica', new_src + ' - ' + '<%- chatinfo._id %>');

                               //   document.getElementById("currentmusic").src=new_src;
                                }
                              </script>
                              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" class="btn btn-danger btn-block playlist text-uppercase"><i class="fa fa-shopping-cart"></i>Adicionar Musica</button>       
                    

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Adicionar musica na playlist</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div>
          <div class="form-group">
            <label for="exampleInputtitulo">Titulo</label>
            <input type="text" class="form-control" id="exampleInputtitulo" aria-describedby="emailHelp" placeholder="">
            </div>
          <div class="form-group">
            <label for="exampleInputartistas">Artistas</label>
            <input type="text" class="form-control" id="exampleInputartistas" placeholder="">
          </div>
          <div class="form-group">
            <label for="exampleInputyotube">Link do youtube</label>
            <input type="text" class="form-control" id="exampleInputyotube" placeholder="">
          </div>
          
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        <button onclick="updatePlaylist()" type="button" class="btn btn-primary">Salvar</button>

        <script>
          function updatePlaylist() {
              const titulo = document.getElementById("exampleInputtitulo").value;
              const artistas = document.getElementById("exampleInputartistas").value;
              const youtubelink = document.getElementById("exampleInputyotube").value;
              const data = {"chatid":"<%- chatinfo._id %>","data":{ "titulo":titulo, "artistas":artistas, "youtubelink":youtubelink }};
   
              fetch("http://localhost:3000/adicionar_musica_playlist", {
                   method: "POST",
                   headers: {
                       "Content-Type": "application/json"
                   },
                   body: JSON.stringify(data)
              })
               .then(response => response.json())
               .then(result => {
                console.log(result)
                document.getElementById("sucesssaveuser").style.display="block"

                  //  document.getElementById("result").innerHTML
                  //    = JSON.stringify(result);
               })
              .catch(error => {
                  console.error(error);
               });
          };
      </script>
      </div>
    </div>
  </div>
</div>
                                   </div>
                    <hr class="d-block d-lg-none mt-1 mb-0">
                  </div>
                  <div class="col-12 col-lg-7 col-xl-9">
                    <div class="py-2 px-4 border-bottom d-none d-lg-block">
                      <div class="d-flex align-items-center py-1">
                        <div class="position-relative">
                          <img src="<%- chatinfo.imagem %>" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                        </div>
                        <div class="flex-grow-1 pl-3">
                          <strong><%- chatinfo.nome %></strong>
                          <div class="text-muted small"><em><%- chatinfo.descricao %></em></div>
                        </div>
                      </div>
                    </div>
          
                    <div class="position-relative">
                      <div id="messages" class="chat-messages p-4">
                      </div>
                    </div>
          
                    <form id="form" action="" class="flex-grow-0 py-3 px-4 border-top">
                      <div class="input-group">
                      <input id="input" autocomplete="off" class="form-control" placeholder="Digite a tua mensagem"/>
                      <button class="btn btn-primary">Send</button>
                    </div>
                    </form>
          
                  </div>
                </div>
              </div>
            </div>
        </main>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="/js/scripts.js"></script>

        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

        <script>
  var socket = io();

  var messages = document.getElementById('messages');
  var form = document.getElementById('form');
  var input = document.getElementById('input');

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (input.value) {
      var m = input.value + ' - ' + '<%- username %>'
      socket.emit('chat message', m);

      document.getElementById("messages")
                .insertAdjacentHTML("beforeend",
                '<div class="chat-message-right pb-4"><div><img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40"><div class="text-muted small text-nowrap mt-2">2:33 am</div></div><div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3"><div class="font-weight-bold mb-1"><%- username %></div>'+input.value+'</div></div>');
      
      input.value = '';

      window.scrollTo(0, document.body.scrollHeight);
    }
  });

  socket.on('chat message', function(msg) {
    var m = msg.split("-")[0].trim()
    var user_sender = msg.split("-")[1].trim()
    var current_user = '<%- username %>'
    
    if (current_user!=user_sender){
      document.getElementById("messages")
                  .insertAdjacentHTML("beforeend",
                  '<div class="chat-message-left pb-4"><div><img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40"><div class="text-muted small text-nowrap mt-2">2:33 am</div></div><div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3"><div class="font-weight-bold mb-1">Tu</div>'+m+'</div></div>');
        
      window.scrollTo(0, document.body.scrollHeight);
    }
  });

  socket.on('mudar musica', function(msg) {
    var m = msg.split("-")[0].trim() + "?autoplay=1&loop=1&autopause=0&muted=0&autohide=0&controls=0&autoStart=1"
    var chat_sender = msg.split("-")[1].trim()
    var current_chat = '<%- chatinfo._id %>'
    
    if (current_chat==chat_sender){
      document.getElementById("currentmusic").src=m;
    //  document.getElementById("currentmusic").play()
    }
  });
</script>
    </body>
    
</html>
